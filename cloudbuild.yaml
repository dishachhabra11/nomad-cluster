steps:
# 1. Initialize Terraform
- id: 'terraform init'
  # Use a publicly available Terraform Docker image (builder)
  name: 'hashicorp/terraform:1.6.6'
  entrypoint: 'terraform'
  # Command arguments: terraform init
  args: ["-chdir=./infrastructure", "init"]

- id: 'terraform plan'
  name: 'hashicorp/terraform:latest'
  entrypoint: 'bash'
  args:
      - '-c'
      - |
          export TF_VAR_nomad_client_secret="$NOMAD_SECRET"

          # Run terraform plan inside infrastructure folder
          terraform -chdir=./infrastructure plan -out=tfplan -var="project_id=${_PROJECT_ID}"
  secretEnv:
      - NOMAD_SECRET
      
# 3. Apply the Plan (deploy changes)
# This step is often conditional to prevent accidental deployments
# For a basic example, we include it here:
- id: 'terraform apply'
  name: 'hashicorp/terraform:latest'
  # Command arguments: terraform apply tfplan
  entrypoint: 'terraform'
  args: ["-chdir=./infrastructure",'apply', 'tfplan']

  # Set a timeout for the apply step to prevent indefinite runs
  timeout: '1200s' 

options:
  # This tells Cloud Build to send logs to Cloud Logging instead of a GCS bucket
  logging: CLOUD_LOGGING_ONLY


availableSecrets:
- secret: 'nomad_oath_client_secret' # The actual name of the secret in Secret Manager
  version: 'latest'        # Or a specific version, like '1'
  # The environment variable name used in the 'secretEnv' and 'export' command
  env: 'NOMAD_SECRET'